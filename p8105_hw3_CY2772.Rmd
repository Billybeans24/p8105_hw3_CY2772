---
title: "p8105_hw3_CY2772"
author: "Chenhui Yan"
date: "2024-10-13"
output: github_document
---
# Load Libraries and Set Plot Settings
```{r}
# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(patchwork) # For combining plots
library(ggridges)
library(hexbin)     # For hexbin plots
library(lubridate)
library(p8105.datasets)

# Set global plot options
knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = '90%'
)

options(
  ggplot2.continuous.color = 'viridis',
  ggplot2.continuous.fill = 'viridis'
)

scale_color_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

# Problem 1
## Part a): Load and describe the Data:
```{r}
data("ny_noaa")
# View the dimensions of the dataset
dim(ny_noaa)
# View the structure of the dataset
str(ny_noaa)
# Summarize the dataset
summary(ny_noaa)
```
### A short description of the dataset:
* The ny_noaa dataset contains 2,595,176 observations and 7 variables.
* Variables:
  * id: Weather station identifier.
  * date: Date of the observation.
  * prcp: Precipitation (tenths of mm).
  * snow: Snowfall (mm).
  * snwd: Snow depth (mm).
  * tmax: Maximum temperature (tenths of degrees C).
  * tmin: Minimum temperature (tenths of degrees C).

### Missing Data:
```{r}
# Calculate missing data percentages
ny_noaa %>%
  summarise(
    prcp_missing = mean(is.na(prcp)) * 100,
    snow_missing = mean(is.na(snow)) * 100,
    snwd_missing = mean(is.na(snwd)) * 100,
    tmax_missing = mean(is.na(tmax)) * 100,
    tmin_missing = mean(is.na(tmin)) * 100
  )

```
* Observations:
  * Approximately 5.62% of prcp values are missing.
  * Approximately 14.68% of snow values are missing.
  * Approximately 22.80% of snwd values are missing.
  * A significant portion of tmax (43.69%) and tmin (46.23%) values are missing.

## Part b): Data cleaning
### Create Year, Month, and Day Variables
```{r}
# Create separate variables for year, month, and day
ny_noaa = ny_noaa %>%
  mutate(
    year = year(date),
    month = month(date),
    day = day(date)
  )
```
### Convert Units to Reasonable Measures
* Temperature: Convert from tenths of degrees Celsius to degrees Celsius.
* Precipitation: Convert from tenths of mm to mm.
```{r}
# Convert `prcp`, `tmax`, and `tmin` to numeric before changing units
ny_noaa = ny_noaa %>%
  mutate(
    prcp = as.numeric(prcp),
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin)
  )
# Adjust units for temperature and precipitation
ny_noaa = ny_noaa %>%
  mutate(
    prcp = prcp / 10,  # Precipitation in mm
    tmax = tmax / 10,  # Max temp in °C
    tmin = tmin / 10   # Min temp in °C
  )
```

### Identify Most Common Snowfall Values
```{r}
# Count the occurrences of each snowfall value
snow_counts = ny_noaa %>%
  count(snow) %>%
  arrange(desc(n))

# View the most common snowfall values
head(snow_counts)

```
* The most commonly observed value for snowfall is 0 mm, with 2,008,508 occurrences.
* This is expected as snowfall doesn't occur every day, especially outside the winter months.

## Part c) Visualization:
### Average Max Temperature in January and July Across Years
```{r}
##Prepare Data
# Filter data for January and July
jan_jul_temps = ny_noaa %>%
  filter(month %in% c(1, 7)) %>%
  group_by(id, year, month) %>%
  summarise(
    mean_tmax = mean(tmax, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(month = if_else(month == 1, "January", "July"))
##Create Plots
# Plot for January
p_jan = ggplot(jan_jul_temps %>% filter(month == "January"), 
                aes(x = year, y = mean_tmax, group = id, color = id)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Average Max Temperature in January",
    x = "Year",
    y = "Mean Max Temperature (°C)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

# Plot for July
p_jul <- ggplot(jan_jul_temps %>% filter(month == "July"), 
                aes(x = year, y = mean_tmax, group = id, color = id)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Average Max Temperature in July",
    x = "Year",
    y = "Mean Max Temperature (°C)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

# Combine plots using patchwork
(p_jan / p_jul) + plot_layout(heights = c(1, 1))

```

* Seasonal Patterns:

  * The January plot shows mean maximum temperatures below freezing for many stations. This is expected, as January is a winter month in New York.
  * The July plot shows mean maximum temperatures generally around 25°C to 30°C, which aligns with typical summer weather.
  
* Yearly Variation:
  
  * In both January and July, there is a regular seasonal cycle where temperatures seem consistent year-over-year, suggesting stability in average             seasonal temperatures over time.
  * However, in some years, the spread of the data seems more significant, indicating variations between different weather stations or some abnormal     weather patterns.
  
* Outliers:

  * January: There are a few points that appear significantly lower than others, especially in the 1980s, indicating some extremely cold values. These         could be legitimate observations or data errors.
  * July: There are some outliers around 15°C, which seem lower than the rest of the data points in the same period. These could be caused by errors in       data collection or unusual weather events.


## Part d) Visualization of tmax vs tmin Plot and Snowfall Distribution
### i. tmax vs tmin Plot
```{r}
# Hexbin plot for tmax vs tmin
p_temp = ggplot(ny_noaa, aes(x = tmin, y = tmax)) +
  geom_hex(bins = 50) +
  labs(
    title = "Relationship Between Minimum and Maximum Temperatures",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)"
  ) +
  theme_minimal()

```
### ii. Snowfall Distribution by Year

```{r}
# Filter snowfall data
snowfall_filtered = ny_noaa %>%
  filter(snow > 0, snow < 100)
# Plot snowfall distribution by year using boxplots
p_snow = ggplot(snowfall_filtered, aes(x = factor(year), y = snow)) +
  geom_boxplot(outlier.size = 0.5, alpha = 0.7) +
  labs(
    title = "Distribution of Snowfall by Year",
    x = "Year",
    y = "Snowfall (mm)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    panel.grid.major.x = element_blank()
  )
# Combine the temperature and snowfall plots
p_temp + p_snow + plot_layout(ncol = 1)
```

# Problem 2
## Part a): Load, Tidy, and Organize the Data Sets
```{r}
##Load the Data
# Read in the demographic data
demographics = read.csv("./dataset_hw3/nhanes_covar.csv", skip = 4)

# Read in the accelerometer data
accelerometer = read.csv("./dataset_hw3/nhanes_accel.csv")

## Inspect the Data
# Inspect demographics data
str(demographics)
summary(demographics)

# Inspect accelerometer data
str(accelerometer)
summary(accelerometer)

##Exclude Participants Less Than 21 Years of Age and Those with Missing Demographic Data
# Exclude participants under 21
demographics = demographics %>%
  filter(age >= 21)

# Remove rows with missing demographic data
demographics = demographics %>%
  drop_na()

##Merge the Data Sets
# Merge datasets on SEQN
data = merge(accelerometer, demographics, by = "SEQN") %>% 
  pivot_longer(
    min1:min1440,
    names_to = "minute_interval",
    values_to = "MIMS"
  ) %>%
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c('male','female')),
    education = factor(education, levels = c(1, 2, 3), labels = c('Less than high school','High school equivalent','More than high school')),
    minute_interval = str_remove(minute_interval,'min')
    )
```
I merge the data and remove observations with age less than 21 or missing data in demographic data. Variable sex and education are set to be factors, repectively with levels “male, female” and “Less than high school, High school equivalent, More than high school”. Also, I remove strings “min” from variable “minute_interval”.


## Part b): Produce a Reader-Friendly Table












